{% extends 'base/home_newtemplate.html' %}
{% block title %}Situación Final{% endblock title %}
{% block form %}
<div class="container mt-4">
    <h2>Archivos de Situaciones Finales</h2>
    
    <a href="{% url 'subir_archivo' %}" class="btn btn-primary mb-3">
        <i class="fas fa-plus"></i> Subir Nuevo Archivo
    </a>
    
    <div class="card">
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Archivo</th>
                        <th>Fecha Subida</th>
                        <th>Estado</th>
                        <th>Procesados</th>
                        <th>Errores</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for archivo in archivos %}
                    <tr>
                        <td>{{ archivo.id }}</td>
                        <td>{{ archivo.archivo.name|slice:"30:" }}</td>
                        <td>{{ archivo.fecha_subida|date:"d/m/Y H:i" }}</td>
                        <td>
                            {% if archivo.procesado %}
                                <span class="badge bg-success">Procesado</span>
                            {% else %}
                                <span class="badge bg-warning">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>{{ archivo.total_procesados }}</td>
                        <td>{{ archivo.total_errores }}</td>
                        <td>
                            {% if not archivo.procesado %}
                                <button class="btn btn-sm btn-primary procesar-btn" 
                                        data-archivo-id="{{ archivo.id }}">
                                    <i class="fas fa-cog"></i> Procesar
                                </button>
                            
                                {% endif %}
                                <button class="btn btn-sm btn-danger eliminar-btn" 
                                        data-situacion-id="{{ archivo.id }}"
                                        data-alumno="{{ archivo.matricula.Alumno.NombreCompleto }}"
                                        data-situacion="{{ archivo.situacion_final }}">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No hay archivos subidos</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal para resultados -->
    <div class="modal fade" id="resultadosModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resultados del Procesamiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="resultadosContenido"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal de confirmación -->
<div class="modal fade" id="confirmarEliminarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de eliminar la situación final de <strong id="alumno-nombre"></strong>?</p>
                <p>Situación: <span class="badge bg-warning" id="situacion-texto"></span></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Esta acción no se puede deshacer. Para registrar nuevamente, deberá procesar un nuevo archivo.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmar-eliminar-btn">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block js1 %}
<script>
$(document).ready(function() {
    $('.procesar-btn').click(function() {
        const archivoId = $(this).data('archivo-id');
        const btn = $(this);
        
        // Preguntar confirmación
        if (!confirm('¿Está seguro de procesar este archivo? Esto puede tomar algunos minutos.')) {
            return;
        }
        
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin"></i> Procesando...');
        
        // Crear formulario para petición síncrona
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/situacionfinal/procesar/${archivoId}/`;
        form.style.display = 'none';
        
        // Agregar CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        // Agregar al documento
        document.body.appendChild(form);
        
        // Hacer la petición FETCH (que puede capturar errores HTTP)
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            // Primero verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error(`La respuesta no es JSON. Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mostrar resultados exitosos
                let html = `<div class="alert alert-success">
                            ${data.message}
                        </div>`;
                
                if (data.resultados && data.resultados.length > 0) {
                    html += `<table class="table table-sm">
                        <thead>
                            <tr>
                                <th>PDF</th>
                                <th>DNI</th>
                                <th>Alumno</th>
                                <th>Situación</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    data.resultados.forEach(function(item) {
                        const estadoClass = item.estado === 'NUEVO' || item.estado === 'PROCESADO' ? 'success' : 
                                          item.estado === 'ACTUALIZADO' ? 'warning' : 'danger';
                        html += `<tr>
                            <td>${item.pdf}</td>
                            <td><code>${item.dni}</code></td>
                            <td>${item.alumno}</td>
                            <td>${item.situacion}</td>
                            <td><span class="badge bg-${estadoClass}">${item.estado}</span></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += `<div class="alert alert-info">No se procesaron archivos PDF.</div>`;
                    
                    // Mostrar información de debug si existe
                    if (data.debug) {
                        html += `<div class="mt-3">
                            <h6>Información de depuración:</h6>
                            <pre style="font-size: 12px; max-height: 200px; overflow-y: auto;">${JSON.stringify(data.debug, null, 2)}</pre>
                        </div>`;
                    }
                }
                
                $('#resultadosContenido').html(html);
                $('#resultadosModal').modal('show');
                
                // Recargar después de 3 segundos si hubo procesamiento
                if (data.estadisticas && (data.estadisticas.nuevos > 0 || data.estadisticas.actualizados > 0)) {
                    setTimeout(function() {
                        location.reload();
                    }, 3000);
                }
            } else {
                // Mostrar error
                let errorHtml = `<div class="alert alert-danger">
                    <h5>Error: ${data.message}</h5>`;
                
                if (data.debug) {
                    errorHtml += `<pre style="font-size: 12px; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.debug, null, 2)}</pre>`;
                }
                
                errorHtml += `</div>`;
                $('#resultadosContenido').html(errorHtml);
                $('#resultadosModal').modal('show');
            }
        })
        .catch(error => {
            // Error de red o respuesta no JSON
            console.error('Error:', error);
            $('#resultadosContenido').html(`
                <div class="alert alert-danger">
                    <h5>Error de conexión o respuesta inválida</h5>
                    <p>${error.message}</p>
                    <p>Revise la consola del navegador (F12) para más detalles.</p>
                </div>
            `);
            $('#resultadosModal').modal('show');
        })
        .finally(() => {
            // Limpiar y restaurar botón
            btn.prop('disabled', false);
            btn.html('<i class="fas fa-cog"></i> Procesar');
            document.body.removeChild(form);
        });
    });
    
    // Eliminar archivo (esta función ya la tienes)
    let situacionIdAEliminar = null;
    
    $('.eliminar-btn').click(function() {
        situacionIdAEliminar = $(this).data('situacion-id');
        const alumnoNombre = $(this).data('alumno');
        const situacionTexto = $(this).data('situacion');
        
        $('#alumno-nombre').text(alumnoNombre);
        $('#situacion-texto').text(situacionTexto);
        $('#confirmarEliminarModal').modal('show');
    });
    
    $('#confirmar-eliminar-btn').click(function() {
        if (!situacionIdAEliminar) return;
        
        const btn = $(this);
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin"></i> Eliminando...');
        
        $.ajax({
            url: '/situacionfinal/eliminar/' + situacionIdAEliminar + '/',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Eliminar la fila de la tabla
                    $('#situacion-' + situacionIdAEliminar).fadeOut(300, function() {
                        $(this).remove();
                    });
                    
                    // Mostrar mensaje de éxito
                    mostrarMensaje('success', response.message, response.detalle);
                } else {
                    mostrarMensaje('error', 'Error', response.message);
                }
                $('#confirmarEliminarModal').modal('hide');
            },
            error: function() {
                mostrarMensaje('error', 'Error', 'No se pudo comunicar con el servidor');
                $('#confirmarEliminarModal').modal('hide');
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-trash"></i> Eliminar');
                situacionIdAEliminar = null;
            }
        });
    });
    
    function mostrarMensaje(tipo, titulo, mensaje) {
        // Crear alerta temporal
        const alerta = $('<div class="alert alert-' + tipo + ' alert-dismissible fade show" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
                        '<strong>' + titulo + '</strong> ' + mensaje +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>');
        
        $('body').append(alerta);
        
        // Auto-eliminar después de 5 segundos
        setTimeout(function() {
            alerta.alert('close');
        }, 5000);
    }
});
</script>
{% endblock js1 %}